<% @vote_column = capture do %>
	<% if p.people.include? @current_user %>
		<%= link_to t('.unvote'), vote_path(p.vote_for(@current_user)), :method => :delete, :remote => true, :class => 'unvote-button' %>
	<% else %>
		<%= link_to t(".vote"), votes_path(:place => p), :method => :post, :remote => true, :class => 'vote-button' %>
	<% end %>
<% end %>

<% @place_column = capture do %>
	<span class="place-name">
        <%= p.name %>
    </span>
    
    <%=t '.added_by', :name => p.person.name %>
	
    <%= p.formatted_notes %>
    
	<% if p.leaving_at %>
	<p class="place-time"><%=t '.leaving_at' %> <%= p.leaving_at.to_s(:time) %></p>
	<% end %>
<% end %>

<% @vote_table = capture do %>
	<% unless p.votes.empty? -%>
		<% if p.walkable? %>
		<ul>
			<% p.votes.each do |v| -%>
			<li id="vote_<%=v.id%>">
				<%= v.person.name %>
			</li>
			<% end %>
		</ul>
		<% else %>
		<table class="car-seats">
			<tr>
				<% p.car_owners.each do |person, votes| %>
				<td data-car="<%= person.try(:car).try(:id) %>" data-place="<%= p.id %>">
					<strong><%= person and t('.person_car', :name => person.name) or t('.unclaimed') %></strong><br/>
                    <%=t '.seats_left', :count => person.car.seats_left(p) if person %>
					<ul>
                        <% votes.each do |vote| %>
                        <li class="<%= "mine" if vote.person == @current_user %>"
                            data-vote="<%= vote.id %>"
                            data-place="<%= p.id %>">
                            <%= vote.person.name %>
							<% if vote.person == @current_user %>
							<%= link_to t('.comment'), edit_vote_path(vote), remote: true, class: 'comment-button' %>
                            <% elsif !vote.comment.blank? %>
                            <span class="vote-comment ui-icon-comment ui-icon" title="<%=vote.comment%>"></span>
							<% end %>
                        </li>
                        <% end %>
					</ul>
				</td>
				<% end %>
			</tr>
		</table>
		<% end %>
	<% end %>
<% end %>

<% @walking_column = capture do %>
    <%= p.walkable? and t('.walking') or t('.driving') %>
<% end %>

<% @edit_column = capture do %>
    <%= link_to t('.edit'), edit_place_path(p), remote: true, class: 'edit-button' if p.person == @current_user %>
<% end %>

<% @delete_column = capture do %>
    <%= link_to t('.delete.text'), place_path(p), method: :delete, confirm: t('.delete.confirm'), remote: true, class: 'delete-button' if p.person == @current_user %>
<% end %>

<tr id="place_<%=p.id%>">
	<td width="70"><%= @vote_column %></td>
	<td>
		<%= @place_column %>
		<%= @vote_table %>
	</td>
	<td width="80"><%= @walking_column %></td>
	<td width="20"><%= @edit_column %></td>
	<td width="20"><%= @delete_column %></td>
</tr>